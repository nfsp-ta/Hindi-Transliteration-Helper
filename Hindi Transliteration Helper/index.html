<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="lib.js"></script>
    <title>Hindi Transliteration Helper</title>
  </head>
  <body>
  <div class="container">
	<nav class="navbar navbar-expand-lg navbar-light bg-light justify-content-between">
	<b>Transliteration Helper</b>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNavDropdown">
    <ul class="navbar-nav">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="fileMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          File
        </a>
        <div class="dropdown-menu" aria-labelledby="fileMenu">
          <a class="dropdown-item openLink" href="#">Open...</a>
          <a class="dropdown-item loadLink" href="#">Load from Clipboard...</a>
          <a class="dropdown-item saveLink" href="#">Save...</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="optionsMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Options
        </a>
        <div class="dropdown-menu" aria-labelledby="optionsMenu">
          <a class="dropdown-item testLink" href="#">Test <span id="testSpan"></span></a>
        </div>
      </li>
    </ul>
  </div>
</nav>
<br />
<div id="article"></div>
  </div>
    <input type="file" style="display:none" id="fileLoader" accept=".json" />
  <style>
	.pair {
		display: inline-block;
		text-align: center;
		margin: 5px;
	}
	.en {
		width: 100%;
		text-align: center;
	}
	.hio {
		display: none;
	}
	.txt {
		height: 1.25em;
		min-height: 1.25em;
		line-height: 1.25;
	}
	.edt {
		text-align: center;
		display: none;
		align-self: center;
		width: 1em;
		border: none;
		padding: 0;
	}
  </style>

  <script>
  
  function download(data, filename, type) {
    var file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
        window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
        var a = document.createElement("a"),
                url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);  
        }, 0); 
    }
}
  var article = [];
  $(document).ready(function(){
  
	$(".loadLink").on("click", function(evt) {
		var dlgDiv = $("<div class='dlgDiv'>");
		dlgDiv.append($("<h5>").append("Paste Hindi text below, then click 'Load'"));
		dlgDiv.append($("<textarea class='clip' placeholder='Paste Here' style='width: 100%; height: 200px;'>"));
		dlgDiv.dialog({
			autoOpen: true,
			modal: true,
			title: "Load From Clipboard",
			width: 600,
			buttons: [
			{
				text: "Load",
				click: function() {
					loadHindi($(".clip").val());
				}
			},
			{
				text: "Cancel",
				click: function() {
					$(".dlgDiv").dialog("close");
				}
			}
			],
			close: function() {
				$(this).remove();
				}
			});
	});
	$(".openLink").on("click", function(evt) {
		$("#fileLoader").on("change", function(evt) {
			var theFile = $("#fileLoader")[0].files[0];
			if (theFile.size > 0)
			{
				var reader = new FileReader();
				reader.readAsText(theFile);
				reader.onload = function() {
					article = JSON.parse(reader.result);
					updateArticle();
				};
			}
			
		});
		$("#fileLoader").click();
	});
	$(".saveLink").on("click", function(evt) {
		download(JSON.stringify(article), "article.json");
	});
	
	checked = "Y";
	if (checked == "Y") {
		$("#testSpan").append($("<span class='glyphicon glyphicon-ok'>"));
	} else {
		$("#testSpan").empty();
	}
	
	$(".testLink").on("click",function(evt){
		checked = (checked == "Y" ? "N" : "Y");
	});
	
	//loadHindi("हे इसराएल सुन, हमारा परमेश्‍वर यहोवा एक ही यहोवा है। तू अपने परमेश्‍वर यहोवा से पूरे दिल, पूरी जान और पूरी ताकत से प्यार करना।—व्यव. 6:4, 5.\r\n\r\n“यहोवा हमारा परमेश्‍वर है, यहोवा एक ही है।” क्या ही दमदार बात!");
	
  });
	
	function loadHindi(txt) {
		txt = txt.replace(/\n\n/g, "\n");
		var ary1 = txt.split("\n");
		ary1.forEach(function(par){
			var parTmp = [];
			var txt2 = par.replace(/—/g, " —");
			var ary2 = txt2.split(" ");
			var rgx = /[^\u0900-\u0963\u0965-\u097F]*/gi
			ary2.forEach(function(e){
				parTmp.push({h: e, hw: e.replace(rgx,"") , e: ""});
			});
			article.push(parTmp);
		});
		updateArticle();
		$(".dlgDiv").dialog("close");
	}
	
	function updateArticle() {
		$("#article").empty();
		article.forEach(function(par){
			var parTemp = $("<p style='display: flex; flex-wrap: wrap;'>");
			par.forEach(function(e){
				parTemp.append(
					$("<div class='pair'>")
						.append($("<div class='hi'>").append(e.h))
						.append($("<div class='hio'>").append(e.hw))
						.append(
							$("<div class='en'>")
								.append($("<div class='txt'>").append(e.e))
								.append($("<input class='edt'>")))
				);
			});
			$("#article").append(parTemp);
		});
	}
	
	function editField(element) {
		$(".edt").hide();
		$(".txt").show();
		var edt = $(element).find(".edt");
		var txt = $(element).find(".txt");
		txt.hide();
		edt.val(txt.html());
		edt.show();		
		edt.focus();
		edt.select();
		edt.one("focusout", function() {
			var origHindi = edt.closest(".pair").find(".hio").html();
			var enTrns = edt.val();
			txt.html(enTrns);
			$(".pair").each(function(i,e) {
				if ($(e).find(".hio").html() == origHindi)
					$(e).find(".txt").html(enTrns);
			});
			article.forEach(function(par){par.forEach(function(e) {
				if (e.hw == origHindi)
					e.e = enTrns;
			});});
		});
		edt.trigger("input");
	}
	
	$("body").on("click", ".en", function (evt) {
		editField(this);
	});
	
	
	$.fn.textWidth = function(text, font) {
		if (!$.fn.textWidth.fakeEl)
			$.fn.textWidth.fakeEl = $('<pre>').hide().appendTo(document.body);
		
		$.fn.textWidth.fakeEl.text(text || this.val() || this.text() || this.attr('placeholder')).css('font', font || this.css('font'));
		
		return $.fn.textWidth.fakeEl.width() + 10;
	};
	
	$('body').on('keydown', '.edt', function(evt) {
		if (($(this).val().length == 0 && evt.key == "Backspace") || ( this.selectionStart == 0 && evt.key == "ArrowLeft")) {
			$(this).one('keyup', function() {
				$(this).trigger('change');
				editField($(this).closest(".pair").prevAll(".pair").first().find(".en").focus());
			});
		}
		if (this.selectionStart == $(this).val().length && evt.key == "ArrowRight") {
			$(this).one('keyup', function() {
				$(this).trigger('change');
				editField($(this).closest(".pair").nextAll(".pair").first().find(".en").focus());
			});
		}
	});
	
	$('body').on('input', '.edt', function() {
		if ($(this).val().slice(-1) == " ") {
			var newVal = $(this).val().trim();				
			$(this).val(newVal);
			editField($(this).closest(".pair").nextAll(".pair").first().find(".en").focus());
		} else {
			var inputWidth = $(this).textWidth();
			$(this).css({
				width: inputWidth
			});
		}
	}).trigger('input');

  </script>
  </body>
</html>